<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, viewport-fit=cover"
    />
    <link rel="manifest" href="/manifest.webmanifest" />
    <link rel="apple-touch-icon" href="/icon-192x192.png" />
    <title>Tropang Tukmol</title>

    <!-- Styles -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
    />
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css"
    />

    <!-- CORRECT SCRIPT ORDER - Supabase FIRST -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="supabase-init.js"></script>
    <script src="emojis.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.all.min.js"></script>
  </head>

  <body>
    <div class="app-layout" id="appLayout">
      <!-- SIDEBAR -->
      <aside class="sidebar" id="sidebar">
        <div class="sidebar-header">
          <div class="user-welcome">
            <div id="sidebarUserAvatar" class="sidebar-user-avatar"></div>
            <div class="sidebar-user-text">
              <small>Welcome back,</small>
              <h3 id="sidebarUsername">User</h3>
            </div>
          </div>
          <button
            class="sidebar-burger"
            id="sidebarBurger"
            title="Toggle sidebar"
          >
            ‚ò∞
          </button>
        </div>

        <div class="stories-container" id="onlineUsersContainer"></div>

        <div class="channel-list">
          <div class="list-label">Channels</div>

          <div
            class="channel-item active"
            data-room-name="general-1"
            data-room-display="General 1"
          >
            <div class="avatar-box purple">#</div>
            <div class="channel-info">
              <h4>General 1</h4>
              <p>Main room</p>
            </div>
            <span class="time">Now</span>
          </div>

          <div
            class="channel-item"
            data-room-name="general-2"
            data-room-display="Debugging"
          >
            <div class="avatar-box pink">#</div>
            <div class="channel-info">
              <h4>Debugging</h4>
              <p>Used for testing messages</p>
            </div>
            <span class="time">2m</span>
          </div>

          <div
            class="channel-item"
            data-room-name="general-3"
            data-room-display="Announcement"
          >
            <div class="avatar-box teal">#</div>
            <div class="channel-info">
              <h4>Announcement</h4>
              <p>Update & Announcement regarding to this website</p>
            </div>
            <span class="time">5m</span>
          </div>
        </div>

        <div class="sidebar-notify-toggle">
          <span>Notifications</span>
          <label class="switch">
            <input id="notificationToggle" type="checkbox" checked />
            <span class="slider"></span>
          </label>
        </div>

        <div class="sidebar-footer">
          <button id="installPwaBtn" class="sidebar-pill install-btn">
            <span>Download app</span>
          </button>
          <button id="settingsBtn" class="sidebar-pill settings-btn">
            <i class="fa-solid fa-gear"></i><span>Settings</span>
          </button>
          <div class="sidebar-version">v1.4.0</div>
          <button id="logoutBtn" class="sidebar-pill logout-btn">
            <i class="fa-solid fa-right-from-bracket"></i><span>Logout</span>
          </button>
        </div>
      </aside>

      <div class="sidebar-backdrop" id="sidebarBackdrop"></div>

      <!-- CHAT AREA -->
      <main class="chat-area" id="chatArea">
        <!-- Header -->
        <header class="chat-header">
          <div class="header-left">
            <button class="back-btn-mobile" id="mobileBackBtn">
              <svg
                width="24"
                height="24"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2.5"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
              </svg>
            </button>
            <button
              class="sidebar-burger"
              id="headerBurger"
              title="Open sidebar"
            >
              ‚ò∞
            </button>
            <div class="header-info">
              <h2 id="roomNameHeader">General</h2>
              <div class="status"><span class="dot"></span> Online</div>
            </div>
          </div>
          <div class="header-right">
            <button class="icon-btn-ghost"></button>
            <button
              id="notificationBtn"
              class="notification-btn"
              title="Notifications"
            >
              <i class="fa-solid fa-bell"></i>
              <span id="notificationBadge" class="notification-badge" hidden
                >0</span
              >
            </button>
            <button id="refreshChatBtn" title="Refresh chat">‚ü≥</button>
            <button id="themeToggle">üåô</button>
          </div>
        </header>
        <div id="notificationPanel" class="notification-panel" hidden>
          <div class="notification-panel-header">
            <span>Notifications</span>
            <button id="markAllReadBtn" type="button">Mark all read</button>
          </div>
          <div id="notificationList" class="notification-list"></div>
        </div>

        <!-- Messages Container -->
        <div
          id="messages"
          class="messages-container"
          data-bubble-style="solid"
          data-chat-texture=""
        ></div>

        <!-- New Messages Button -->
        <div id="newMessagesBtn" class="new-messages-btn">‚Üì New Messages</div>
        <!-- SINGLE Typing Indicator (REMOVED DUPLICATE!) -->
        <div id="typingIndicator" class="typing-indicator">
          <span class="typing-indicator-label">Someone is typing</span>
          <span class="typing-indicator-dots">
            <span class="typing-indicator-dot"></span>
            <span class="typing-indicator-dot"></span>
            <span class="typing-indicator-dot"></span>
          </span>
        </div>
        <!-- Input Section -->
        <div class="input-section">
          <div class="drag-overlay" id="dragOverlay">
            <div class="drag-overlay-inner">
              <div class="drag-icon">‚¨ÜÔ∏è</div>
              <div class="drag-text-main">
                Drop your image into the chat box
              </div>
              <div class="drag-text-sub">You can add up to 4 images</div>
            </div>
          </div>
          <div id="replyPreview" class="reply-preview" hidden>
            <div class="reply-preview-content">
              <div class="reply-preview-label">Replying to</div>
              <div id="replyPreviewName" class="reply-preview-name"></div>
              <div id="replyPreviewText" class="reply-preview-text"></div>
            </div>
            <button
              id="cancelReplyBtn"
              class="reply-cancel-btn"
              type="button"
              title="Cancel reply"
            >
              x
            </button>
          </div>
          <div class="input-wrapper">
            <label for="imageInput" class="attach-btn">+</label>
            <input
              type="file"
              id="imageInput"
              accept="image/*,.pdf,.doc,.docx,.xls,.xlsx,.ppt,.pptx,.txt,.csv,.zip,.rar,.7z"
              hidden
            />

            <div class="text-field-container">
              <div id="inputLabel" class="edit-badge" hidden>Editing</div>
              <textarea
                id="messageInput"
                placeholder="Message..."
                autocomplete="off"
                rows="1"
              ></textarea>
              <button id="emojiBtn" class="emoji-btn">üòä</button>
            </div>

            <button id="sendBtn" class="send-btn">
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="currentColor"
              >
                <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
              </svg>
              <span id="sendIcon"></span>
            </button>
            <button id="cancelEditBtn" class="cancel-edit-btn" hidden>‚úï</button>
          </div>

          <div class="file-preview" id="filePreview"></div>
          <div id="emojiSuggestions" class="emoji-suggestions"></div>
        </div>
      </main>
    </div>

    <!-- Modals -->
    <div id="imageViewerContainer"></div>
    <div id="logoutOverlay" class="logout-overlay">
      <div class="logout-modal">
        <div class="logout-icon">‚ö†</div>
        <h3>Sign out of Tropang Tukmol?</h3>
        <p>You will leave this session. Your chats stay safe.</p>
        <div class="logout-actions">
          <button
            type="button"
            id="logoutCancelBtn"
            class="logout-btn logout-btn--ghost"
          >
            Stay
          </button>
          <button
            type="button"
            id="logoutConfirmBtn"
            class="logout-btn logout-btn--primary"
          >
            Leave
          </button>
        </div>
        <div class="logout-progress">
          <div class="logout-progress-bar"></div>
        </div>
      </div>
    </div>

    <!-- Scripts - CORRECT FINAL ORDER -->
    <script src="https://unpkg.com/emoji-js@3.8.0/lib/emoji.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <script src="settings.js"></script>
    <!-- SINGLE script.js AT END -->
    <script type="module" src="script.js"></script>

    <!-- Inline mobile handlers -->
    <script>
      document.addEventListener('DOMContentLoaded', () => {
        const appLayout = document.getElementById('appLayout');
        const sidebarBurger = document.getElementById('sidebarBurger');
        const headerBurger = document.getElementById('headerBurger');
        const mobileBackBtn = document.getElementById('mobileBackBtn');

        sidebarBurger?.addEventListener('click', () =>
          appLayout.classList.add('chat-active'),
        );
        headerBurger?.addEventListener('click', () =>
          appLayout.classList.remove('chat-active'),
        );
        mobileBackBtn?.addEventListener('click', () =>
          appLayout.classList.remove('chat-active'),
        );

        if (window.innerWidth <= 768) appLayout.classList.add('chat-active');
      });
    </script>

    <link rel="stylesheet" href="style.css" />
  </body>
</html>
